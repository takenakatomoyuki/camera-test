<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>バーコード読み取り</title>
</head>
<body>
    <h1>バーコード読み取りテスト更新</h1>
    <div id="scanner"></div>
    <p id="result"></p>

    <!-- QuaggaJSの読み込み -->
    <script src="https://unpkg.com/@ericblade/quagga2@1.7.4/dist/quagga.min.js"></script>
    <script>
        const lambdaUrl = "https://sqdrefua7h.execute-api.ap-northeast-1.amazonaws.com/jancode";//APIGatewayで更改したURLを貼る

        window.onload = function () {
            Quagga.init({
                inputStream: {//カメラ映像の入力設定
                    type: "LiveStream",//スマホやPCのカメラ映像をリアルタイムで使用できるやつ
                    target: document.querySelector('#scanner'),//映像を映す場所を指定（今回の場合、divのidを指定している）
                    constraints: {
                        facingMode: "environment" // 背面カメラを指定
                    }
                },
                decoder: {
                    readers: ["ean_reader"] // 一般的なバーコードの指定（ean_readerがEANコード、qr_readerがQRコード）
                }
            }, function (err) {
                if (err) {
                    console.error(err);
                    return;
                }
                Quagga.start();//上記の初期化が完了したらこの関数でカメラを起動する
            });

            Quagga.onDetected(async function (result) {//QRコードが読み込まれたら呼び出されるイベントハンドラ。（reslt）には読み取ったバーコードの情報が含まれている
                alert("EANコード読みとった : " + result)
                const barcode = result.codeResult.code;//バーコードの情報のみを抽出し、変数barcodeに格納する
                document.getElementById("result").textContent = "読み取ったバーコード: " + barcode;//HTMLの画面上に読み取ったQRコード情報を出力するための処理。（今回の場合、pタグのidを指定している）

                try {
                    alert("APIGatewayに繋ぐよー")
                    const response = await fetch("https://sqdrefua7h.execute-api.ap-northeast-1.amazonaws.com/jancode", {//ここでAWSAPIGatewayに接続を試みる（Post通信でheadersにjson情報だよという指定と、bodyにjson文字列にしたバーコードの情報を乗せて送信する）
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ barcode: barcode })
                    });
                    
                    const rawData = await response.text(); // まずはテキストとして受け取る
                    let resultData;

                    const resultData = await response.json();//Lambdaから返却された情報でjsonデータのみ抽出してresultDataに格納する

                    alert("Lambdaからの返却値　：　" + resultData.message); // Lambdaからのメッセージを表示
                } catch (error) {
                    console.error("送信エラー:", error);
                    alert("バーコード送信に失敗しました");
                }

                //Quagga.stop(); // 読み取り後に停止
            });
        };
    </script>
</body>
</html>
