<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>バーコード読み取り</title>
</head>
<body>
    <h1>バーコード読み取りテスト</h1>
    <div id="scanner"></div>
    <p id="result"></p>

    <!-- QuaggaJSの読み込み -->
    <script src="https://unpkg.com/@ericblade/quagga2@1.7.4/dist/quagga.min.js"></script>
    <script>
        const lambdaUrl = "https://zm1pticc9k.execute-api.ap-northeast-1.amazonaws.com/calcRestApi";//APIGatewayで更改したURLを貼る
                alert("カメラ起動！！")
                alert("カメラ起動！！")
                alert("カメラ起動！！")

        window.onload = function () {
            Quagga.init({
                inputStream: {//カメラ映像の入力設定
                    type: "LiveStream",//スマホやPCのカメラ映像をリアルタイムで使用できるやつ
                    target: document.querySelector('#scanner'),//映像を映す場所を指定（今回の場合、divのidを指定している）
                    constraints: {
                        facingMode: "environment" // 背面カメラを指定
                    }
                },
                decoder: {
                    readers: ["qr_reader"] // 一般的なバーコードの指定（ean_readerがEANコード、qr_readerがQRコード）
                }
            }, function (err) {
                if (err) {
                    console.error(err);
                    return;
                }
                Quagga.start();//上記の初期化が完了したらこの関数でカメラを起動する
            });
let lastBarcode = null;

Quagga.onDetected(async function (result) {
    alert("読み取れた？")
    const barcode = result.codeResult.code;

    // 同じバーコードなら無視
    if (barcode === lastBarcode) return;
    lastBarcode = barcode;

    document.getElementById("result").textContent = "読み取ったバーコード: " + barcode;

    try {
        const response = await fetch(lambdaUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ barcode: barcode })
        });

        const resultData = await response.json();
        alert(resultData.message);
    } catch (error) {
        console.error("送信エラー:", error);
        alert("バーコード送信に失敗しました");
    }

    // 一時停止して、再開
    Quagga.stop();
    setTimeout(() => {
        Quagga.start();
    }, 2000);
});

        };
    </script>
</body>
</html>
